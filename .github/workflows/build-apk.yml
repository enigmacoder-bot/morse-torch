name: Build Standalone APK

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
      
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'
      
      - name: Install dependencies
        run: npm install
      
      - name: Setup Expo CLI
        run: npm install -g @expo/cli eas-cli
      
      - name: Clear caches
        run: |
          rm -rf node_modules/.cache
          rm -rf .expo
          rm -rf /tmp/metro-* 2>/dev/null || true
          rm -rf /tmp/haste-* 2>/dev/null || true
      
      - name: Generate Android project
        run: npx expo prebuild --platform android --clean
      
      - name: Update Kotlin version to 1.9.25
        run: |
          # Update Kotlin version in root build.gradle
          sed -i 's/kotlinVersion = "1.9.24"/kotlinVersion = "1.9.25"/' android/build.gradle
          sed -i "s/kotlinVersion = '1.9.24'/kotlinVersion = '1.9.25'/" android/build.gradle
          sed -i 's/ext\.kotlinVersion = "1.9.24"/ext.kotlinVersion = "1.9.25"/' android/build.gradle
          sed -i "s/ext\.kotlinVersion = '1.9.24'/ext.kotlinVersion = '1.9.25'/" android/build.gradle
          
          echo "=== Updated Kotlin version to 1.9.25 ==="
          grep -n "kotlin" android/build.gradle | head -20 || echo "No kotlinVersion found in build.gradle"
      
      - name: Make gradlew executable
        run: chmod +x ./android/gradlew
      
      - name: Clean and build APK
        run: |
          ./gradlew clean
          ./gradlew assembleRelease --stacktrace
        working-directory: android
        env:
          NODE_ENV: production
      
      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: morse-flash-standalone-apk
          path: android/app/build/outputs/apk/release/*.apk
